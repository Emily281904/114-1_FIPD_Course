// --- 1. Pin Configuration & Constants ---
const int buttonPin = 2;   // Pin connected to the button module's signal pin (IN)
const int RLedPin = 9;     // Pin for Red (PWM)
const int GLedPin = 10;    // Pin for Green (PWM)
const int BLedPin = 11;    // Pin for Blue (PWM)

// --- 2. Variables for Button Handling ---
int buttonState = 0;               
bool buttonPressed = false;        
unsigned long pressingTime = 0;    
const int longPressInterval = 500; // 500ms threshold for long press

// --- 3. Variables for Modes and Color ---
// LightNum: 0=White, 1=Red, 2=Blue, 3=Green, 4=Yellow
int LightNum = 0;
// RLightColor, GLightColor, BLightColor: The target color
int RLightColor = 0;
int GLightColor = 0;
int BLightColor = 0;
// RCurrentColor, GCurrentColor, BCurrentColor: The actual color displayed
int RCurrentColor = 0;
int GCurrentColor = 0;
int BCurrentColor = 0;
// currentMode: 0=Steady, 1=Slow Blink, 2=Medium Blink, 3=Fast Blink
int currentMode = 0; 

// --- 4. Variables for Blink Modes (Modes 1, 2, 3) ---
const int slowBlinkInterval = 1000;  // Slow: 1000ms (1 second)
const int mediumBlinkInterval = 500; // Medium: 500ms
const int fastBlinkInterval = 150;   // Fast: 150ms
unsigned long blinkTimer = 0;  
bool blinkOn = true;           

// ------------------------------------
// --- Core Functions ---
// ------------------------------------

void setRGBLEDColor(int r, int g, int b) {
    analogWrite(RLedPin, r);
    analogWrite(GLedPin, g);
    analogWrite(BLedPin, b);
}

void changeLightColor() {
    // Cycles through 5 colors (0-4)
    LightNum = (LightNum + 1) % 5; 

    RLightColor = 0;
    GLightColor = 0;
    BLightColor = 0;

    switch (LightNum) {
        case 0: // White
            RLightColor = 255; GLightColor = 255; BLightColor = 255; break;
        case 1: // Red
            RLightColor = 255; break;
        case 2: // Blue
            BLightColor = 255; break;
        case 3: // Green
            GLightColor = 255; break;
        case 4: // Yellow
            RLightColor = 255; GLightColor = 255; break;
    }
}

void changeMode() {
    // Cycles through 4 modes (0, 1, 2, 3)
    currentMode = (currentMode + 1) % 4; // <<< NEW LOGIC: % 4

    // Reset blink variables for all blink modes (Modes 1, 2, 3)
    if (currentMode >= 1 && currentMode <= 3) { 
        blinkTimer = 0;
        blinkOn = true;
    } 
}

void updateLEDColor() {
    // Determine the interval for blinking
    int activeBlinkInterval = 0; 

    if (currentMode == 0) { // Mode 0: Steady Light Mode
        RCurrentColor = RLightColor;
        GCurrentColor = GLightColor;
        BCurrentColor = BLightColor;
    } 
    else if (currentMode >= 1 && currentMode <= 3) { // Modes 1, 2, 3: Blink Modes
        
        // 1. Set the interval based on the current mode
        if (currentMode == 1) { // Slow Blink
            activeBlinkInterval = slowBlinkInterval;
        } else if (currentMode == 2) { // Medium Blink
            activeBlinkInterval = mediumBlinkInterval;
        } else if (currentMode == 3) { // Fast Blink
            activeBlinkInterval = fastBlinkInterval;
        }

        // 2. Non-blocking blinking logic
        unsigned long currentTime = millis();
        if (currentTime - blinkTimer >= activeBlinkInterval) {
            blinkOn = !blinkOn; // Toggle state
            blinkTimer = currentTime; 
        }

        // 3. Set the current color based on blink state
        if (blinkOn) {
            RCurrentColor = RLightColor;
            GCurrentColor = GLightColor;
            BCurrentColor = BLightColor;
        } else {
            RCurrentColor = 0;
            GCurrentColor = 0;
            BCurrentColor = 0;
        }
    } 
    // The previous 'Breathing Mode' (Mode 2) is removed to meet the new 4-mode requirement.
}

void checkButton() {
    buttonState = digitalRead(buttonPin);

    // 1. Detect button press start (Module gives LOW when pressed with INPUT_PULLUP)
    if (buttonState == LOW && !buttonPressed) { 
        pressingTime = millis();
        buttonPressed = true;
    }

    // 2.Detect button release (Module returns to HIGH when released)
    if (buttonState == HIGH && buttonPressed) { 
        unsigned long currentTime = millis();
        
        // Short Click (less than 500ms)
        if (currentTime - pressingTime < longPressInterval) {
            changeLightColor(); 
        } 
        // Long Press (500ms or more)
        else {
            changeMode(); 
        }
        
        buttonPressed = false; 
    }
}

// ------------------------------------
// --- setup() and loop() ---
// ------------------------------------

void setup() {
    // Set LED pins as OUTPUT
    pinMode(RLedPin, OUTPUT);
    pinMode(GLedPin, OUTPUT);
    pinMode(BLedPin, OUTPUT);
    
    // Set button pin as INPUT_PULLUP for reliability.
    // This expects the button module's VCC pin to be disconnected (see instructions).
    pinMode(buttonPin, INPUT_PULLUP); 
    
    // Initialize the starting color (White)
    changeLightColor(); 
}

void loop() {
    checkButton();
    updateLEDColor();
    setRGBLEDColor(RCurrentColor, GCurrentColor, BCurrentColor);
}
